<template>
  <div class="bg-blue">
    <div class="fr-container">
      <nav
        role="navigation"
        class="fr-p-4w fr-breadcrumb"
        aria-label="vous Ãªtes ici :"
      >
        <button
          class="fr-breadcrumb__button"
          aria-expanded="false"
          aria-controls="breadcrumb-1"
        >
          {{ $t("see-breadcrumb") }}
        </button>
        <div class="fr-collapse" id="breadcrumb-1">
          <ol class="fr-breadcrumb__list">
            <li>
              <a class="fr-breadcrumb__link" href="/">Accueil</a>
            </li>
            <li>
              <a class="fr-breadcrumb__link" aria-current="page">Contact</a>
            </li>
          </ol>
        </div>
      </nav>
      <section>
        <div class="fr-grid-row fr-grid-row--center">
          <div class="fr-col-12">
            <div class="main fr-p-4w">
              <div class="main-bar fr-grid-row">
                <div class="header-title mobile-margin">
                  <h1 class="fr-mr-2w fr-mb-0 fr-mt-0">
                    {{ $t("title-contact") }}
                  </h1>
                </div>
              </div>
              <div class="main-description fr-mt-2w">
                <i18n path="contact-description" tag="p">
                  <template v-slot:doc_link>
                    <a
                      href="https://docs.dossierfacile.fr"
                      title="Documentation DossierFacile"
                      target="_blank"
                      >{{ $t("our-documentation") }}</a
                    >
                  </template>
                </i18n>
              </div>
              <div
                v-if="status == 'OK'"
                class="bg-white fr-px-md-14w mail-success-container"
              >
                <div class="fr-py-4w text-center green-title">
                  {{ $t("message-sent-title") }}
                </div>
                <div class="fr-pb-4w fr-px-md-7w text-center">
                  {{ $t("message-sent-text") }}
                </div>
                <div class="fr-pb-4w text-center">
                  <DfButton class="" primary="true">
                    <a
                      class="fr-external-link"
                      href="https://docs.dossierfacile.fr"
                      title="Documentation DossierFacile"
                      target="_blank"
                      rel="noreferrer noopener "
                      >{{ $t("consult-our-documentation") }}</a
                    >
                  </DfButton>
                </div>
              </div>
              <div v-if="status == 'KO'" class="bg-white fr-p-4w fr-px-md-10w">
                <Modal @close="closeModal" id="submit-error-modal">
                  <template v-slot:body>
                    <div class="fr-container">
                      <div class="fr-grid-row justify-content-center">
                        <div class="fr-col-12">
                          <p>
                            {{ $t("contact-submit-error") }}
                          </p>
                        </div>
                      </div>
                    </div>
                  </template>
                </Modal>
              </div>
              <div v-if="status != 'OK'" class="bg-white fr-p-4w fr-px-md-10w">
                <ValidationObserver v-slot="{ handleSubmit }">
                  <form v-on:submit.prevent="handleSubmit(submitForm)">
                    <div class="fr-grid-row fr-grid-row--center">
                      <div class="fr-col-12 fr-mb-3w">
                        <RequiredFieldsInstruction></RequiredFieldsInstruction>
                      </div>
                      <div class="fr-col-12 fr-col-md-6 fr-pr-md-3w fr-mb-3w">
                        <div class="fr-input-group">
                          <FieldLabel for-input="firstname">
                            {{ $t("firstname") }}
                          </FieldLabel>
                          <input
                            id="firstname"
                            :placeholder="$t('firstname')"
                            type="text"
                            v-model="contactFormData.firstname"
                            name="firstname"
                            autocomplete="given-name"
                            class="validate-required form-control fr-input"
                          />
                        </div>
                      </div>
                      <div class="fr-col-12 fr-col-md-6 fr-mb-3w">
                        <div class="fr-input-group">
                          <FieldLabel for-input="lastname">
                            {{ $t("lastname") }}
                          </FieldLabel>
                          <input
                            v-model="contactFormData.lastname"
                            class="form-control fr-input validate-required"
                            id="lastname"
                            name="lastname"
                            autocomplete="family-name"
                            :placeholder="$t('lastname')"
                            type="text"
                          />
                        </div>
                      </div>
                      <div class="fr-col-12 fr-mb-3w">
                        <validation-provider
                          rules="required|email"
                          v-slot="{ errors, valid }"
                        >
                          <div
                            class="fr-input-group"
                            :class="errors[0] ? 'fr-input-group--error' : ''"
                          >
                            <FieldLabel :required="true" for-input="email">
                              {{ $t("email") }}
                            </FieldLabel>
                            <input
                              v-model="contactFormData.email"
                              class="form-control fr-input validate-required"
                              :class="{
                                'fr-input--valid': valid,
                                'fr-input--error': errors[0]
                              }"
                              id="email"
                              name="email"
                              autocomplete="email"
                              :placeholder="$t('email')"
                              type="text"
                            />
                            <span class="fr-error-text" v-if="errors[0]">{{
                              $t(errors[0])
                            }}</span>
                          </div>
                        </validation-provider>
                      </div>
                      <div class="fr-col-12 fr-mb-3w">
                        <validation-provider
                          rules="required"
                          v-slot="{ errors, valid }"
                        >
                          <fieldset
                            class="fr-radio-group-container"
                            :class="{
                              'fr-fieldset--valid': valid,
                              'fr-fieldset--error': errors[0]
                            }"
                            aria-labelledby="radio-profile-legend"
                            role="group"
                          >
                            <legend id="radio-profile-legend">
                              {{ $t("profile") }}
                              <span style="color:red"> *</span> :
                            </legend>
                            <input
                              v-model="contactFormData.profile"
                              id="profile-tenant"
                              type="radio"
                              name="profile"
                              value="profile-tenant"
                              checked="checked"
                            />
                            <label
                              class="fr-ml-md-4w fr-px-8w fr-py-2w"
                              for="profile-tenant"
                              >{{ $t("tenant") }}</label
                            >
                            <input
                              v-model="contactFormData.profile"
                              id="profile-owner"
                              type="radio"
                              name="profile"
                              value="profile-owner"
                            />
                            <label
                              class="fr-ml-md-2w fr-px-8w fr-py-2w"
                              for="profile-owner"
                              >{{ $t("owner") }}</label
                            >
                          </fieldset>
                          <span class="fr-error-text" v-if="errors[0]">{{
                            $t(errors[0])
                          }}</span>
                        </validation-provider>
                      </div>
                      <div class="fr-col-12 fr-mb-3w">
                        <validation-provider
                          rules="required"
                          v-slot="{ errors, valid }"
                        >
                          <div
                            class="fr-input-group"
                            :class="errors[0] ? 'fr-input-group--error' : ''"
                          >
                            <FieldLabel :required="true" for-input="subject">
                              {{ $t("subject") }}
                            </FieldLabel>
                            <input
                              v-model="contactFormData.subject"
                              class="form-control fr-input validate-required"
                              :class="{
                                'fr-input--valid': valid,
                                'fr-input--error': errors[0]
                              }"
                              id="subject"
                              name="subject"
                              autocomplete="off"
                              :placeholder="$t('subject')"
                              type="text"
                            />
                            <span class="fr-error-text" v-if="errors[0]">{{
                              $t(errors[0])
                            }}</span>
                          </div>
                        </validation-provider>
                      </div>
                      <div class="fr-col-12 fr-mb-3w">
                        <validation-provider
                          rules="required"
                          v-slot="{ errors, valid }"
                        >
                          <div
                            class="fr-input-group"
                            :class="errors[0] ? 'fr-input-group--error' : ''"
                          >
                            <FieldLabel :required="true" for-input="message">
                              {{ $t("message") }}
                            </FieldLabel>
                            <textarea
                              v-model="contactFormData.message"
                              class="form-control fr-input validate-required"
                              :class="{
                                'fr-input--valid': valid,
                                'fr-input--error': errors[0]
                              }"
                              id="message"
                              name="message"
                              autocomplete="off"
                              :placeholder="$t('message')"
                              type="textarea"
                            />
                            <span class="fr-error-text" v-if="errors[0]">{{
                              $t(errors[0])
                            }}</span>
                          </div>
                        </validation-provider>
                      </div>
                      <div class="fr-col-12 fr-mb-3w">
                        <validation-provider
                          rules="is"
                          v-slot="{ errors, valid }"
                        >
                          <div
                            class="bg-purple fr-checkbox-group"
                            :class="{
                              'fr-input-group--valid': valid,
                              'fr-input-group--error': errors[0]
                            }"
                          >
                            <input
                              type="checkbox"
                              id="acceptCgu"
                              v-model="acceptCgu"
                              value="false"
                            />
                            <label for="acceptCgu"
                              ><div v-html="$t('accept-cgu')"></div
                            ></label>
                            <span class="fr-error-text" v-if="errors[0]">{{
                              $t(errors[0])
                            }}</span>
                          </div>
                        </validation-provider>
                      </div>
                      <div class="fr-col-12 fr-mb-3w text-right">
                        <DfButton class="" primary="true">{{
                          $t("submit")
                        }}</DfButton>
                      </div>
                    </div>
                  </form>
                </ValidationObserver>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</template>

<script lang="ts">
import { Component, Prop, Vue } from "vue-property-decorator";
import { extend, ValidationObserver, ValidationProvider } from "vee-validate";
import Modal from "./Modal.vue";
import { is } from "vee-validate/dist/rules";
import DfButton from "df-shared/src/Button/Button.vue";
import RequiredFieldsInstruction from "df-shared/src/components/form/RequiredFieldsInstruction.vue";
import FieldLabel from "df-shared/src/components/form/FieldLabel.vue";
import { ContactFormData } from "df-shared/src/models/ContactFormData";
import { SupportService } from "df-shared/src/services/SupportService";
import { User } from "../models/User";

extend("is", {
  ...is,
  message: "require-accept",
  validate: value => !!value
});

@Component({
  components: {
    ValidationProvider,
    ValidationObserver,
    DfButton,
    Modal,
    RequiredFieldsInstruction,
    FieldLabel
  }
})
export default class ContactForm extends Vue {
  @Prop() user!: User;

  acceptCgu = false;
  contactFormData = new ContactFormData();
  status = "NEW"; // NEW, OK, KO

  mounted() {
    if (this.user) {
      this.contactFormData.firstname = this.user.firstName;
      this.contactFormData.lastname = this.user.lastName;
      this.contactFormData.email = this.user.email;
      this.contactFormData.profile = "profile-tenant";
    }
  }

  submitForm() {
    SupportService.sendMail(this.contactFormData)
      .then(() => {
        this.status = "OK";
      })
      .catch(error => {
        console.log(error);
        this.status = "KO";
      });
  }

  closeModal() {
    this.status = "NEW";
  }
}
</script>

<style scoped lang="scss">
.bg-blue {
  width: 100%;
  background-color: var(--bf100-g750);
}
.bg-white {
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
  border-radius: 10px;
  background: var(--background-default-grey);
}
.text-right {
  text-align: right;
}
.fr-breadcrumb {
  margin-top: 0;
  margin-bottom: 0;
}
textarea {
  height: 12rem;
}
fieldset.fr-radio-group-container {
  border: none;
  padding: 0;
  margin: 0;
  text-align: left;
  input[type="radio"] {
    clip: rect(1px, 1px, 1px, 1px);
    position: absolute !important;
  }
  input[type="radio"]:checked + label {
    background: var(--blue-france-925);
    outline-color: #0a76f6;
    outline-offset: -1px;
    outline-style: auto;
    outline-width: 1px;
    text-shadow: 0 0 1px rgba(0, 0, 0, 0.7);
  }
  input[type="radio"]:focus + label {
    outline-color: #0a76f6;
    outline-offset: 2px;
    outline-style: auto;
    outline-width: 2px;
  }
  label {
    @media all and (min-width: 768px) {
      display: inline-block;
    }
    @media all and (max-width: 767px) {
      margin-right: 0;
      display: flex;
      margin-bottom: 1rem;
    }
    background-color: var(--background-contrast-grey);
    border-radius: 10px;
  }
  legend {
    @media all and (min-width: 992px) {
      display: contents;
    }
    margin-bottom: 1rem;
  }
}
.fr-fieldset--error {
  legend {
    color: var(--text-default-error);
  }
}
.green-title {
  color: green;
  font-weight: bold;
  font-size: 1rem;
  padding-top: 0 !important;
}
.mail-success-container:before {
  content: url("../assets/enveloppe.webp");
  text-align: center;
  position: relative;
  margin: 0;
  padding: 0;
  top: -20px;
  left: calc(50% - 29px);
  font-size: 4rem;
}
.fr-external-link::after {
  content: "";
}
</style>

<i18n>
{
"en": {
"title-contact": "Contact Us",
"firstname": "Firstname",
"lastname": "Lastname",
"email": "Email",
"profile": "User's profile",
"subject": "Subject",
"message": "Message",
"cancel": "Cancel",
"submit" : "Send my message",
"owner": "Owner",
"tenant": "Tenant",
"accept-cgu" : "I agree with DossierFacile's Conditions and Terms",
"field-required" : "Field is required",
"require-accept" : "Accept is required",
"email-not-valid" : "Invalid address (example: xxx@domainname.com)",
"our-documentation": "our documentation",
"contact-description" : "If you have any trouble to create your DossierFacile or if your have question which have not response in {doc_link}, you can fill the following form.",
"contact-submit-error" : "Oops... Something wrong happened. May I ask you to contact us by mail at: contact@dossierFacile.fr",
"consult-our-documentation" : "Consult our documentation",
"message-sent-title" : "Thank you !",
"message-sent-text" : "We will do our best to answer you fast. Please consider to ",
"see-breadcrumb": "See breadcrumb"
},
"fr": {
"title-contact": "Contactez notre support",
"firstname": "PrÃ©nom",
"lastname": "Nom",
"email": "Votre adresse e-mail",
"profile": "Votre profil",
"subject": "L'objet de votre message",
"message": "Votre message",
"cancel": "Annuler",
"submit" : "Envoyer mon message",
"owner": "PropriÃ©taire",
"tenant": "Locataire",
"accept-cgu" : "Le support DossierFacile est assurÃ© par des humains travaillant directement pour DossierFacile et qui utilisent le logiciel Helpscout. En contactant le support DossierFacile, je consens Ã  l'utilisation de toutes les donnÃ©es transmises par ce biais Ã  DossierFacile et Helpscout dans le but de rÃ©pondre Ã  ma demande de support.",
"field-required" : "Ce champ est requis",
"require-accept" : "L'acception est requise",
"email-not-valid" : "Adresse non valide (exemple : xxx@nomdedomaine.fr)",
"our-documentation": "notre documentation",
"contact-description" : "Que vous Ã©prouviez des difficultÃ©s Ã  crÃ©er votre DossierFacile, que vous souhaitiez obtenir des renseignements plus prÃ©cis que ce qui est disponible au sein de {doc_link}, ou que ce soit pour glisser un mot sympathique Ã  notre Ã©quipe de choc qui traite vos dossiers avec attention, vous pouvez renseigner le formulaire ci-dessous. Nous faisons de notre mieux afin de rÃ©pondre Ã  tous, dans des dÃ©lais acceptables.",
"contact-submit-error" : "Oops... L'envoi du formulaire a Ã©chouÃ©. Pourriez-vous nous contacter par mail ici: contact@dossierFacile.fr ?",
"consult-our-documentation" : "Consulter notre documentation",
"message-sent-title" : "C'est tout bon ! Votre message est bien arrivÃ© !",
"message-sent-text" : "Nous nous efforÃ§ons de vous rÃ©pondre dans les meilleurs dÃ©lais. D'ici lÃ  n'hÃ©sitez pas Ã ",
"see-breadcrumb": "Voir le fil dâAriane"
}
}
</i18n>