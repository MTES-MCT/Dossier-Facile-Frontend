<template>
  <div class="fr-mb-15w">
    <Form @submit="onSubmit">
      <NakedCard class="fr-p-5w">
        <h1>{{ t('nameinformationform.title') }}</h1>
        <p>{{ t('nameinformationform.subtitle') }}</p>
        <div class="fr-grid-row fr-grid-row--center">
          <div class="fr-col-12 fr-mb-3w">
            <div class="fr-input-group">
              <label class="fr-label" for="lastname"
                >{{ t('nameinformationform.lastname') }} :</label
              >
              <Field
                name="lastname"
                v-model.trim="lastname"
                v-slot="{ field, meta }"
                :rules="{
                  required: true,
                }"
              >
                <input
                  v-bind="field"
                  class="validate-required form-control fr-input"
                  :class="{
                    'fr-input--valid': meta.valid,
                    'fr-input--error': !meta.valid,
                  }"
                  :placeholder="t('nameinformationform.lastname')"
                  :disabled="franceConnect"
                  type="text"
                />
              </Field>
              <ErrorMessage name="lastname" v-slot="{ message }">
                <span role="alert" class="fr-error-text">{{ t(message || '') }}</span>
              </ErrorMessage>
            </div>
          </div>
          <div class="fr-col-12 fr-mb-3w">
            <div class="fr-input-group">
              <label for="firstname" class="fr-label"
                >{{ t('nameinformationform.firstname') }} :</label
              >
              <Field
                name="firstname"
                v-model.trim="firstname"
                v-slot="{ field, meta }"
                :rules="{
                  required: true,
                }"
              >
                <input
                  v-bind="field"
                  class="validate-required form-control fr-input"
                  :class="{
                    'fr-input--valid': meta.valid,
                    'fr-input--error': !meta.valid,
                  }"
                  :placeholder="t('nameinformationform.firstname')"
                  :disabled="franceConnect"
                  type="text"
                />
              </Field>
              <ErrorMessage name="firstname" v-slot="{ message }">
                <span role="alert" class="fr-error-text">{{ t(message || '') }}</span>
              </ErrorMessage>
            </div>
          </div>
          <div class="fr-col-12 fr-mb-3w">
            <div class="fr-input-group">
              <label for="email" class="fr-label">{{ t('nameinformationform.email') }} :</label>
              <Field
                id="email"
                name="email"
                v-model="email"
                v-slot="{ field, meta }"
                :rules="{
                  email: true,
                  required: true,
                }"
              >
                <input
                  v-bind="field"
                  class="validate-required form-control fr-input"
                  :class="{
                    'fr-input--valid': meta.valid,
                    'fr-input--error': !meta.valid,
                  }"
                  :placeholder="t('nameinformationform.email')"
                  type="email"
                />
              </Field>
              <ErrorMessage name="email" v-slot="{ message }">
                <span role="alert" class="fr-error-text">{{ t(message || '') }}</span>
              </ErrorMessage>
            </div>
          </div>
        </div>
      </NakedCard>
      <ProfileFooter :showBack="false"></ProfileFooter>
    </Form>
  </div>
</template>

<script lang="ts" setup>
import { Form, Field, ErrorMessage } from 'vee-validate';
import NakedCard from 'df-shared-next/src/components/NakedCard.vue';
import { computed, ref } from 'vue';
import { useI18n } from 'vue-i18n';
import { useToast } from 'vue-toastification';
import router from '../../router';
import ProfileFooter from '../footer/ProfileFooter.vue';
import useOwnerStore from '../../store/owner-store';

const { t } = useI18n();
const store = useOwnerStore();
const toast = useToast();

const properties = store.getProperties;

const franceConnect = computed(() => store.getUser?.franceConnect);

const firstname = ref(store.getUser?.firstName || '');
const lastname = ref(store.getUser?.lastName || '');
const email = ref(store.getUser?.email || '');

function onSubmit() {
  store
    .saveNames(lastname.value, firstname.value, email.value)
    .then(() => {
      if (properties.length > 0) {
        router.push({ name: 'Dashboard' });
        return;
      }
      router.push({ name: 'PropertyName' });
    })
    .catch((err) => {
      if (err.response.data.message.includes('email_exists')) {
        toast.error(t('nameinformationform.email-exists').toString(), {
          timeout: 7000,
        });
      }
    });
}
</script>
